## Dataset description. 
##var_match: Patient ID of matched electronic medical record 
##index: Serial number of electronic medical record data
##ZYZD: Primary diagnosis
##QTZD: Secondary diagnosis
##ZFY_i: cost recorded in the data entry

## cost_scen1: Used to store the cost of a single consultation under the primary win-all scenario
cost_scen1 <- vector(mode = "list", length = length(var_match))
## cost_scen2: Used to store the cost of a single consultation under the primary dominated scenario
## cost_scen3: Used to store the cost of a single consultation under the duplication counting scenario
names(cost_scen1) <- var_match; cost_scen2 <- cost_scen3 <- cost_scen1

## Calculate the cost in a single electronic medical record data under different scenarios
for(i in index) {
  ## Extract information from each data entry
  ZYZD_i <- ZYZD[i]; QTZD_i <- QTZD[[i]]; ZFY_i <- var_pay[i,1];
  ## Skip data with no diagnosis results
  if(ZYZD_i == "") {next
  } else {
    ## If there is only a primary diagnosis, the costs under the three scenarios are the same
    if(QTZD_i[1] == "") {
      res <- ZFY_i; names(res) <- ZYZD_i
      cost_scen1[[i]] <- cost_scen2[[i]] <- cost_scen3[[i]] <- res
    } else { ## Calculate when there are both primary and secondary diagnoses
      temp <- length(QTZD_i) + 1
      res <- rep(0, temp); names(res) <- c(ZYZD_i, QTZD_i)
      ##main analyses: primary win-all
      res[1] <- ZFY_i
      cost_scen1[[i]] <- res
      ##alternative scenario analyses:primary dominated
      res[1] <- ZFY_i * 0.8; res[-1] <- rep(ZFY_i * 0.2 / (temp - 1), temp - 1)
      cost_scen2[[i]] <- res
      ##alternative scenario analyses:duplication counting
      res <- rep(ZFY_i, temp); names(res) <- c(ZYZD_i, QTZD_i)
      cost_scen3[[i]] <- res
    }
  }
}

## Deduplicate patient IDs
pat <- unique(var_match)
## For each patient, sum all costs for each disease
for (i in 1:length(pat)) {
  ## The i-th patient
  p <- pat[i]
  ## Extract all consultation cost records for this patient
  duplicates <- which(names(cost_scen1) == p)
  du <- cost_scen1[duplicates]
  ## Create an empty list for summation
  sums <- list()
  ## Iterate over each element
  for (element in du) {
    names_in_element <- names(element)
    for (name in names_in_element) {
      if (!name %in% names(sums)) {
        ## If the name does not appear in sums yet, initialize to 0
        sums[[name]] <- 0
      }
      ## Accumulate the corresponding value of the current element
      sums[[name]] <- sums[[name]] + element[[name]]
    }
  }
  ## Put the summed results back to their first occurrence position
  for (j in seq_along(du)) {
    for (name in names(du[[j]])) {
      if (name %in% names(sums)) {
        ## If the name is in sums, update its value
        du[[j]][[name]] <- sums[[name]]
        ## Remove the name from sums to avoid duplicate placement
        sums[[name]] <- NULL
      }
    }
  }
  cost_scen1[duplicates] <- du
}
